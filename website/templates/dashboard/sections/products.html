<div class="flex justify-between items-center mb-6">
  <h2 class="text-2xl font-bold text-[#1d5675]">مدیریت محصولات</h2>
  <button class="btn bg-[#e66700] border-0 hover:bg-[#b25204] text-white" onclick="openProductModal()">➕ محصول جدید</button>
</div>

<div class="overflow-x-auto bg-white rounded-lg shadow">
  <table class="table">
    <thead class="bg-[#1d5675] text-white">
      <tr>
        <th>#</th>
        <th>نام محصول</th>
        <th>قیمت</th>
        <th>دسته‌بندی</th>
        <th>مدیریت</th>
      </tr>
    </thead>
    <tbody>
      {% for p in products %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ p.title }}</td>
        <td>{{ p.price|default:"-" }}</td>
        <td>{{ p.category.title|default:"-" }}</td>
        <td class="flex gap-2">
          <button class="btn btn-xs bg-blue-500 text-white border-0 hover:bg-blue-600"
                  onclick="editProduct({{ p.id }}, '{{ p.title }}', '{{ p.price }}', '{{ p.category.id|default:'' }}')">ویرایش</button>
          <button class="btn btn-xs bg-red-500 text-white border-0 hover:bg-red-600"
                  onclick="confirmDeleteProduct({{ p.id }}, '{{ p.title }}')">حذف</button>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="text-center py-4 text-gray-500">هیچ محصولی یافت نشد.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal Form -->
<input type="checkbox" id="product_modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box max-w-md">
    <h3 id="modalTitle" class="font-bold text-lg text-[#e66700] mb-4">افزودن محصول جدید</h3>
    <form id="productForm">
      <input type="hidden" id="productId" name="product_id" />
      <input type="text" id="productName" name="title" placeholder="نام محصول" class="input input-bordered w-full mb-2" required />
      <input type="number" id="productPrice" name="price" placeholder="قیمت (تومان)" class="input input-bordered w-full mb-2" required />
      <select id="productCategory" name="category" class="select select-bordered w-full mb-2" required>
        <option value="">دسته‌بندی</option>
        {% for cat in categories %}
        <option value="{{ cat.id }}">{{ cat.title }}</option>
        {% endfor %}
      </select>
      <div class="modal-action">
        <label for="product_modal" class="btn">بستن</label>
        <button type="submit" class="btn bg-[#e66700] border-0 hover:bg-[#b25204] text-white">ذخیره</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Modal -->
<input type="checkbox" id="delete_modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-red-600">تأیید حذف</h3>
    <p class="py-4" id="deleteMessage">آیا مطمئن هستید؟</p>
    <div class="modal-action">
      <label for="delete_modal" class="btn">لغو</label>
      <button id="confirmDeleteBtn" class="btn bg-red-600 text-white hover:bg-red-700 border-0">حذف</button>
    </div>
  </div>
</div>

<script>
let editing = false;
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

function openProductModal() {
  editing = false;
  document.getElementById("modalTitle").innerText = "افزودن محصول جدید";
  document.getElementById("productForm").reset();
  document.getElementById("productId").value = "";
  document.getElementById("product_modal").checked = true;
}

function editProduct(id, title, price, categoryId) {
  editing = true;
  document.getElementById("modalTitle").innerText = "ویرایش محصول";
  document.getElementById("product_modal").checked = true;
  document.getElementById("productId").value = id;
  document.getElementById("productName").value = title;
  document.getElementById("productPrice").value = price;
  document.getElementById("productCategory").value = categoryId;
}

function confirmDeleteProduct(id, name) {
  document.getElementById("delete_modal").checked = true;
  document.getElementById("deleteMessage").innerText = `آیا از حذف محصول "${name}" مطمئن هستید؟`;
  document.getElementById("confirmDeleteBtn").onclick = async () => {
    const res = await fetch(`/dashboard/products/delete/${id}/`, {
      method: "POST",
      headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrfToken }
    });
    const data = await res.json();
    if (data.success) loadSection('products');
    else alert("حذف انجام نشد.");
  };
}

document.getElementById("productForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const url = editing ? "/dashboard/products/update/" : "/dashboard/products/create/";
  const res = await fetch(url, {
    method: "POST",
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrfToken }
  });
  const data = await res.json();
  if (data.success) {
    document.getElementById("product_modal").checked = false;
    loadSection('products');
  } else {
    alert("خطایی رخ داد.");
  }
});
</script>
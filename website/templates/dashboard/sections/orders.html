{% extends "dashboard/base_dashboard.html" %}
{% load jalali_tags %}
{% load humanize %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="flex gap-2 text-2xl font-bold">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M9 6H15C15 4.34315 13.6569 3 12 3C10.3431 3 9 4.34315 9 6ZM7 6C7 3.23858 9.23858 1 12 1C14.7614 1 17 3.23858 17 6H20C20.5523 6 21 6.44772 21 7V21C21 21.5523 20.5523 22 20 22H4C3.44772 22 3 21.5523 3 21V7C3 6.44772 3.44772 6 4 6H7ZM5 8V20H19V8H5ZM9 10C9 11.6569 10.3431 13 12 13C13.6569 13 15 11.6569 15 10H17C17 12.7614 14.7614 15 12 15C9.23858 15 7 12.7614 7 10H9Z"></path></svg>
    سفارشات
  </h1>
</div>

<div class="overflow-x-auto bg-base-100 shadow rounded-xl">
  <table class="table ">
    <thead>
      <tr>
        <th>ردیف</th>
        <th>نام مشتری</th>
        <th>تاریخ ثبت سفارش</th>
        <th>مبلغ کل فاکتور</th>
      </tr>
    </thead>
    <tbody>
      {% for order in page_obj %}
      <tr class="cursor-pointer hover:bg-gray-100" onclick="openOrderModal({{ order.id }})">
        <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
        <td>{{ order.full_name }}</td>
        <td>{{ order.created_at|to_jalali:"%Y/%m/%d %H:%M" }}</td>
        <td>{{ order.total_price|intcomma }} تومان</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="4" class="text-center text-gray-500">هیچ سفارشی ثبت نشده است.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<div class="mt-4">
  {% include "dashboard/partials/pagination.html" with page_obj=page_obj %}
</div>


<!-- Modal جزئیات سفارش -->
<dialog id="orderModal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">جزئیات سفارش</h3>
    <p id="orderTracking" class="font-semibold mb-2"></p>
    <p id="orderCustomer" class="mb-1"></p>
    <p id="orderAddress" class="mb-3"></p>
    <p id="orderTotal" class="mb-3 font-semibold"></p>

    <div class="overflow-x-auto">
      <table class="table w-full border">
        <thead>
          <tr>
            <th>محصول</th>
            <th>دسته‌بندی</th>
            <th>قیمت واحد</th>
            <th>تعداد</th>
            <th>جمع</th>
          </tr>
        </thead>
        <tbody id="orderItems">
          <!-- لیست محصولات با JS پر می‌شود -->
        </tbody>
      </table>
    </div>

    <p class="text-center font-bold mt-4" id="orderPayment"></p>

    <div class="modal-action">
      <button type="button" class="btn" onclick="closeOrderModal()">بستن</button>
    </div>
  </div>
</dialog>

<script>
  const ordersData = {
    {% for order in page_obj %}
    "{{ order.id }}": {
      "tracking": "{{ order.tracking_code }}",
      "full_name": "{{ order.full_name }}",
      "address": "{{ order.address|linebreaksbr }}",
      "total": "{{ order.total_price|intcomma }}",
      "is_paid": "{{ order.is_paid }}",
      "items": [
        {% for item in order.items.all %}
        {
          "title": "{{ item.product_title }}",
          "category": "{{ item.category }}",
          "price": "{{ item.price|intcomma }}",
          "quantity": "{{ item.quantity }}"
        },
        {% endfor %}
      ]
    },
    {% endfor %}
  };

  function openOrderModal(orderId) {
    const data = ordersData[orderId];
    document.getElementById("orderTracking").innerHTML = `کد پیگیری: <b>${data.tracking}</b>`;
    document.getElementById("orderCustomer").innerText = `نام مشتری: ${data.full_name}`;
    document.getElementById("orderAddress").innerHTML = `آدرس: ${data.address}`;
    document.getElementById("orderTotal").innerText = `مبلغ کل: ${data.total} تومان`;
    document.getElementById("orderPayment").innerText = data.is_paid === "True" ? "پرداخت موفق ✅" : "پرداخت ناموفق ❌";

    const tbody = document.getElementById("orderItems");
    tbody.innerHTML = "";

    data.items.forEach(item => {
      // حذف "," از قیمت و تبدیل به عدد
      const priceNum = parseInt(item.price.replace(/,/g, ''));
      const subtotal = priceNum * parseInt(item.quantity);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.title}</td>
        <td>${item.category}</td>
        <td>${item.price} تومان</td>
        <td>${item.quantity}</td>
        <td>${subtotal.toLocaleString()} تومان</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("orderModal").showModal();
  }

  function closeOrderModal() {
    document.getElementById("orderModal").close();
  }
</script>

{% endblock %}
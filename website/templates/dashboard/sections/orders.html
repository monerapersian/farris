{% extends "dashboard/base_dashboard.html" %}
{% load humanize %}
{% block content %}

<h2 class="text-2xl font-bold mb-6">ğŸ“¦ Ø³ÙØ§Ø±Ø´Ø§Øª</h2>

<table class="table w-full border">
  <thead>
    <tr>
      <th>#</th>
      <th>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ</th>
      <th>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</th>
      <th>Ù…Ø¨Ù„Øº Ú©Ù„ ÙØ§Ú©ØªÙˆØ±</th>
    </tr>
  </thead>
  <tbody>
    {% for order in page_obj %}
    <tr class="cursor-pointer hover:bg-gray-100" onclick="openOrderModal({{ order.id }})">
      <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
      <td>{{ order.full_name }}</td>
      <td>{{ order.created_at|date:"Y/m/d H:i" }}</td>
      <td>{{ order.total_price|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4" class="text-center text-gray-500">Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Pagination -->
<div class="mt-4">
  {% include "dashboard/partials/pagination.html" with page_obj=page_obj %}
</div>

<!-- Modal Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´ -->
<dialog id="orderModal" class="modal w-full max-w-3xl">
  <div class="modal-box relative">
    <h3 class="text-lg font-bold mb-4">Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´</h3>
    <p id="orderTracking" class="font-semibold mb-2"></p>
    <p id="orderCustomer" class="mb-1"></p>
    <p id="orderAddress" class="mb-3"></p>
    <p id="orderTotal" class="mb-3 font-semibold"></p>

    <div class="overflow-x-auto">
      <table class="table w-full border">
        <thead>
          <tr>
            <th>Ù…Ø­ØµÙˆÙ„</th>
            <th>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</th>
            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
            <th>ØªØ¹Ø¯Ø§Ø¯</th>
            <th>Ø¬Ù…Ø¹</th>
          </tr>
        </thead>
        <tbody id="orderItems">
          <!-- Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø§ JS Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
        </tbody>
      </table>
    </div>

    <p class="text-center font-bold mt-4" id="orderPayment"></p>

    <div class="modal-action">
      <button type="button" class="btn" onclick="closeOrderModal()">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</dialog>

<script>
  const ordersData = {
    {% for order in page_obj %}
    "{{ order.id }}": {
      "tracking": "{{ order.tracking_code }}",
      "full_name": "{{ order.full_name }}",
      "address": "{{ order.address|linebreaksbr }}",
      "total": "{{ order.total_price|intcomma }}",
      "is_paid": "{{ order.is_paid }}",
      "items": [
        {% for item in order.items.all %}
        {
          "title": "{{ item.product_title }}",
          "category": "{{ item.category }}",
          "price": "{{ item.price|intcomma }}",
          "quantity": "{{ item.quantity }}"
        },
        {% endfor %}
      ]
    },
    {% endfor %}
  };

  function openOrderModal(orderId) {
    const data = ordersData[orderId];
    document.getElementById("orderTracking").innerHTML = `Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: <b>${data.tracking}</b>`;
    document.getElementById("orderCustomer").innerText = `Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: ${data.full_name}`;
    document.getElementById("orderAddress").innerHTML = `Ø¢Ø¯Ø±Ø³: ${data.address}`;
    document.getElementById("orderTotal").innerText = `Ù…Ø¨Ù„Øº Ú©Ù„: ${data.total} ØªÙˆÙ…Ø§Ù†`;
    document.getElementById("orderPayment").innerText = data.is_paid === "True" ? "Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ âœ…" : "Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ âŒ";

    const tbody = document.getElementById("orderItems");
    tbody.innerHTML = "";

    data.items.forEach(item => {
      // Ø­Ø°Ù "," Ø§Ø² Ù‚ÛŒÙ…Øª Ùˆ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯
      const priceNum = parseInt(item.price.replace(/,/g, ''));
      const subtotal = priceNum * parseInt(item.quantity);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.title}</td>
        <td>${item.category}</td>
        <td>${item.price} ØªÙˆÙ…Ø§Ù†</td>
        <td>${item.quantity}</td>
        <td>${subtotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("orderModal").showModal();
  }

  function closeOrderModal() {
    document.getElementById("orderModal").close();
  }
</script>

{% endblock %}
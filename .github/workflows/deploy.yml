name: Deploy Django Project to Server

on:
  push:
    branches:
      - main  # ÙˆÙ‚ØªÛŒ push Ø±ÙˆÛŒ main Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø±ÛŒÙ¾Ùˆ
      - name: Checkout repository
        uses: actions/checkout@v3

      # Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§ØªØµØ§Ù„ SSH Ø¨Ù‡ Ø³Ø±ÙˆØ± Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: 188.253.2.95                # IP Ø³Ø±ÙˆØ±
          username: farrisir1               # Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ SSH
          key: ${{ secrets.DEPLOY_KEY }}   # Ú©Ù„ÛŒØ¯ Ø®ØµÙˆØµÛŒ SSH Ú©Ù‡ ØªÙˆ GitHub Secrets Ø°Ø®ÛŒØ±Ù‡ Ú©Ø±Ø¯ÛŒ
          port: 22
          script: |
            echo "ğŸŸ¢ Ø´Ø±ÙˆØ¹ Deploy..."
            cd /home/farrisir1/farris_ir   # Ù…Ø³ÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡
            git fetch origin main
            git merge origin/main --ff-only
            source /home/farrisir1/virtualenv/farris_ir/3.12/bin/activate
            pip install -r requirements.txt
            python manage.py migrate
            python manage.py collectstatic --noinput
            # Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ù¾ (Passenger / cPanel)
            if [ -d tmp ]; then
              touch tmp/restart.txt
            fi
            echo "âœ… Deploy Ú©Ø§Ù…Ù„ Ø´Ø¯!"